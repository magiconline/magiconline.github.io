<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>HTTP框架修炼之道 - 魔法张的Blog</title><meta name=description content="1. 再谈HTTP协议 1.1 HTTP协议是什么 HTTP：超文本传输协议
为什么需要协议？ 需要明确的边界
开始 结束 能够携带信息
什么消息 消息类型 1.2 协议里有什么 请求行、状态行 方法名、URL、协议版本 协议版本、状态码、状态码描述 请求头、响应头 请求体、响应体 1.3 请求流程 业务层 服务治理层 中间件层 路由层 协议编码层 传输层 1.4 不足与展望 HTTP1 队头阻塞 传输效率低 明文传输不安全 HTTP2 多路复用 头部压缩 二进制协议 QUIC 基于UDP实现 解决队头阻塞 加密减少握手次数 支持快速启动 2 HTTP框架的设计与实现 2.1 分层设计 高内聚、低耦合 易复用 高扩展性 2.2 应用层设计 提供合理的 API
可理解性 简单性 冗余性 兼容性 可测性 可见性 2.3 中间件设计 中间件需求：
配合 Handler实现一个完整的请求处理生命周期 拥有预处理逻辑与后处理逻辑 可以注册多中间件 对上层模块、用户逻辑模块易用 洋葱模型，适用场景：
日志记录 性能统计 安全控制 事务处理 异常处理 2."><meta name=author content><link rel="preload stylesheet" as=style href=https://magiconline.github.io/app.min.css><link rel="preload stylesheet" as=style href=https://magiconline.github.io/an-old-hope.min.css><script defer src=https://magiconline.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://magiconline.github.io/theme.png><link rel=preload as=image href=https://magiconline.github.io/github.svg><link rel=icon href=https://magiconline.github.io/favicon.ico><link rel=apple-touch-icon href=https://magiconline.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.100.2"><meta property="og:title" content="HTTP框架修炼之道"><meta property="og:description" content="1. 再谈HTTP协议 1.1 HTTP协议是什么 HTTP：超文本传输协议
为什么需要协议？ 需要明确的边界
开始 结束 能够携带信息
什么消息 消息类型 1.2 协议里有什么 请求行、状态行 方法名、URL、协议版本 协议版本、状态码、状态码描述 请求头、响应头 请求体、响应体 1.3 请求流程 业务层 服务治理层 中间件层 路由层 协议编码层 传输层 1.4 不足与展望 HTTP1 队头阻塞 传输效率低 明文传输不安全 HTTP2 多路复用 头部压缩 二进制协议 QUIC 基于UDP实现 解决队头阻塞 加密减少握手次数 支持快速启动 2 HTTP框架的设计与实现 2.1 分层设计 高内聚、低耦合 易复用 高扩展性 2.2 应用层设计 提供合理的 API
可理解性 简单性 冗余性 兼容性 可测性 可见性 2.3 中间件设计 中间件需求：
配合 Handler实现一个完整的请求处理生命周期 拥有预处理逻辑与后处理逻辑 可以注册多中间件 对上层模块、用户逻辑模块易用 洋葱模型，适用场景：
日志记录 性能统计 安全控制 事务处理 异常处理 2."><meta property="og:type" content="article"><meta property="og:url" content="https://magiconline.github.io/post/http%E6%A1%86%E6%9E%B6%E4%BF%AE%E7%82%BC%E4%B9%8B%E9%81%93/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-06-15T19:04:23+08:00"><meta property="article:modified_time" content="2022-06-15T19:04:23+08:00"><meta itemprop=name content="HTTP框架修炼之道"><meta itemprop=description content="1. 再谈HTTP协议 1.1 HTTP协议是什么 HTTP：超文本传输协议
为什么需要协议？ 需要明确的边界
开始 结束 能够携带信息
什么消息 消息类型 1.2 协议里有什么 请求行、状态行 方法名、URL、协议版本 协议版本、状态码、状态码描述 请求头、响应头 请求体、响应体 1.3 请求流程 业务层 服务治理层 中间件层 路由层 协议编码层 传输层 1.4 不足与展望 HTTP1 队头阻塞 传输效率低 明文传输不安全 HTTP2 多路复用 头部压缩 二进制协议 QUIC 基于UDP实现 解决队头阻塞 加密减少握手次数 支持快速启动 2 HTTP框架的设计与实现 2.1 分层设计 高内聚、低耦合 易复用 高扩展性 2.2 应用层设计 提供合理的 API
可理解性 简单性 冗余性 兼容性 可测性 可见性 2.3 中间件设计 中间件需求：
配合 Handler实现一个完整的请求处理生命周期 拥有预处理逻辑与后处理逻辑 可以注册多中间件 对上层模块、用户逻辑模块易用 洋葱模型，适用场景：
日志记录 性能统计 安全控制 事务处理 异常处理 2."><meta itemprop=datePublished content="2022-06-15T19:04:23+08:00"><meta itemprop=dateModified content="2022-06-15T19:04:23+08:00"><meta itemprop=wordCount content="132"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="HTTP框架修炼之道"><meta name=twitter:description content="1. 再谈HTTP协议 1.1 HTTP协议是什么 HTTP：超文本传输协议
为什么需要协议？ 需要明确的边界
开始 结束 能够携带信息
什么消息 消息类型 1.2 协议里有什么 请求行、状态行 方法名、URL、协议版本 协议版本、状态码、状态码描述 请求头、响应头 请求体、响应体 1.3 请求流程 业务层 服务治理层 中间件层 路由层 协议编码层 传输层 1.4 不足与展望 HTTP1 队头阻塞 传输效率低 明文传输不安全 HTTP2 多路复用 头部压缩 二进制协议 QUIC 基于UDP实现 解决队头阻塞 加密减少握手次数 支持快速启动 2 HTTP框架的设计与实现 2.1 分层设计 高内聚、低耦合 易复用 高扩展性 2.2 应用层设计 提供合理的 API
可理解性 简单性 冗余性 兼容性 可测性 可见性 2.3 中间件设计 中间件需求：
配合 Handler实现一个完整的请求处理生命周期 拥有预处理逻辑与后处理逻辑 可以注册多中间件 对上层模块、用户逻辑模块易用 洋葱模型，适用场景：
日志记录 性能统计 安全控制 事务处理 异常处理 2."></head><body class=not-ready data-menu=true><header class=header><p class=logo><a class=site-name href=https://magiconline.github.io/>魔法张的Blog</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList,btnDark=document.querySelector('.btn-dark'),sysDark=window.matchMedia('(prefers-color-scheme: dark)'),darkVal=localStorage.getItem('dark'),setDark=e=>{bodyClx[e?'add':'remove']('dark'),localStorage.setItem('dark',e?'yes':'no')};setDark(darkVal?darkVal==='yes':sysDark.matches),requestAnimationFrame(()=>bodyClx.remove('not-ready')),btnDark.addEventListener('click',()=>setDark(!bodyClx.contains('dark'))),sysDark.addEventListener('change',e=>setDark(e.matches))</script><nav class=menu><a href=/about/>关于</a></nav><nav class=social><a class=github style=--url:url(./github.svg) href=https://github.com/magiconline target=_blank></a></nav></header><main class=main><article class=post-single><header class=post-title><p><time>Jun 15, 2022</time></p><h1>HTTP框架修炼之道</h1></header><section class=post-content><h1 id=1-再谈http协议>1. 再谈HTTP协议</h1><h2 id=11-http协议是什么>1.1 HTTP协议是什么</h2><p>HTTP：超文本传输协议</p><h3 id=为什么需要协议>为什么需要协议？</h3><p>需要明确的边界</p><ul><li>开始</li><li>结束</li></ul><p>能够携带信息</p><ul><li>什么消息</li><li>消息类型</li></ul><h2 id=12-协议里有什么>1.2 协议里有什么</h2><ul><li>请求行、状态行<ul><li>方法名、URL、协议版本</li><li>协议版本、状态码、状态码描述</li></ul></li><li><h2 id=请求头响应头>请求头、响应头</h2></li><li>请求体、响应体</li></ul><h2 id=13-请求流程>1.3 请求流程</h2><ul><li>业务层</li><li>服务治理层</li><li>中间件层</li><li>路由层</li><li>协议编码层</li><li>传输层</li></ul><h2 id=14-不足与展望>1.4 不足与展望</h2><ul><li>HTTP1<ul><li>队头阻塞</li><li>传输效率低</li><li>明文传输不安全</li></ul></li><li>HTTP2<ul><li>多路复用</li><li>头部压缩</li><li>二进制协议</li></ul></li><li>QUIC<ul><li>基于UDP实现</li><li>解决队头阻塞</li><li>加密减少握手次数</li><li>支持快速启动</li></ul></li></ul><h1 id=2-http框架的设计与实现>2 HTTP框架的设计与实现</h1><h2 id=21-分层设计>2.1 分层设计</h2><ul><li>高内聚、低耦合</li><li>易复用</li><li>高扩展性</li></ul><h2 id=22-应用层设计>2.2 应用层设计</h2><p>提供合理的 API</p><ul><li>可理解性</li><li>简单性</li><li>冗余性</li><li>兼容性</li><li>可测性</li><li>可见性</li></ul><h2 id=23-中间件设计>2.3 中间件设计</h2><p>中间件需求：</p><ul><li>配合 Handler实现一个完整的请求处理生命周期</li><li>拥有预处理逻辑与后处理逻辑</li><li>可以注册多中间件</li><li>对上层模块、用户逻辑模块易用</li></ul><p>洋葱模型，适用场景：</p><ul><li>日志记录</li><li>性能统计</li><li>安全控制</li><li>事务处理</li><li>异常处理</li></ul><h2 id=24-路由设计>2.4 路由设计</h2><p>框架路由实际上就是为URL匹配对应的处理函数</p><ul><li>静态路由</li><li>参数路由</li><li>路由修复</li><li>冲突路由以及优先级</li><li>匹配HTTP方法</li><li>多处理函数，方便添加中间件</li></ul><p>实现思路</p><ul><li>map[string]handlers<ul><li>只能处理静态路由</li></ul></li><li>前缀匹配树，在每个节点存储handler<ul><li>可以处理参数路由</li></ul></li></ul><p>匹配HTTP方法：
在前缀树外部设置路由映射表 HTTP/METHOD -> tree</p><h2 id=25-协议层设计>2.5 协议层设计</h2><p>抽象出合适的接口</p><h2 id=26-网络层设计>2.6 网络层设计</h2><p>阻塞IO、非阻塞IO</p><p>网络库：net(BIO)，netpoll(NIO)</p><h1 id=3-性能修炼之道>3 性能修炼之道</h1><h2 id=31-针对网络库的优化>3.1 针对网络库的优化</h2><ul><li>存下全部的Header</li><li>减少系统调用次数</li><li>能够复用内存</li><li>能够多次读</li></ul><h2 id=32-针对协议的优化>3.2 针对协议的优化</h2><ul><li>Headers 解析<ul><li>找到 Header Line 边界：\r\n</li><li>SIMD</li></ul></li></ul><h2 id=33-header-key-规范化>3.3 Header key 规范化</h2><h2 id=34-热点资源池化>3.4 热点资源池化</h2><ul><li>取<ul><li>减少了内存分配</li><li>提高了内存复用</li><li>降低了GC压力</li><li>性能提升</li></ul></li><li>舍<ul><li>额外的Reset逻辑</li><li>请求内有效</li><li>问题定位难度增加</li></ul></li></ul><h1 id=企业实践>企业实践</h1></section><nav class=post-nav><a class=next href=https://magiconline.github.io/post/rpc%E6%A1%86%E6%9E%B6/><span>RPC框架</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2022 <a href=https://magiconline.github.io/>魔法张的Blog</a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p><p><a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper 5.1</a></p></footer></body></html>