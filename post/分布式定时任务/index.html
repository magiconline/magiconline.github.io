<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>分布式定时任务 - 魔法张的Blog</title><meta name=description content="前言 春节集卡瓜分20亿技术 自动化 + 定时执行 + 海量数据 + 高效稳定 = 分布式定时任务
发展历程 单机定时任务 10分钟后Windows电脑自动关机 自动疫情打卡 Linux命令 - CronJob 定时清理机器日志 单机定时任务 Ticker(GO)，定时刷新本地缓存 Quartz 单任务极致控制，没有负载均匀任务 分布式定时任务 平台化管理，分布式部署，支持海量数据
分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。
按触发时机分类：
定时任务：15点触发 延时任务：10s后触发 周期任务：每天15点触发，每10s触发 执行方式：
单级任务：随机触发一台机器执行任务。 广播任务：广播到所有机器上执行同一个任务。 Map任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。 MapReduce任务：在Map任务的基础上，还可以对所有子任务的结果做汇总计算。 定时任务框架 xxl-job
分布式定时任务VS大数据处理引擎：
都可以对海量数据做处理，性能、伸缩性、稳定性都很高。
大数据处理引擎往往致力于将源数据处理成结果数据，分布式定时任务除了能做这个之外，还可以调用HTTP和RPC服务。
以发奖为例：分布式定时任务可以计算哪些用户发奖，然后进行发奖。而大数据处理只能计算哪些用户发奖。
实现原理 核心架构 分布式定时任务核心要解决触发、调度、执行三个关键问题。
触发器：解析任务，生成触发事件。 调度器：分配任务，管理任务生命周期。 执行器：获取执行任务单元，执行任务逻辑。 此外，还需要控制台，提供任务管理和干预的功能。 数据流 控制台 任务：任务元数据 任务实例：任务运行的实例 任务结果：可能任务失败重试产生多个结果 任务历史 任务元数据 包含基础信息、调度时机、执行行为、执行方式。
任务实例 一个确定的Job的一次运行实例。
Job_id 触发时间 状态&结果 过程信息 触发器 核心职责 给定一系列任务，解析他们的触发规则，在规定的时间点触发任务的调度。
设计约束：
需支持大量任务 需支持秒级的任务 周期任务需要多次执行 需保证秒级扫描的高性能，并避免资源浪费 方案1 定时扫描 + 延时消息。"><meta name=author content><link rel="preload stylesheet" as=style href=https://magiconline.github.io/app.min.css><link rel="preload stylesheet" as=style href=https://magiconline.github.io/an-old-hope.min.css><script defer src=https://magiconline.github.io/highlight.min.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=preload as=image href=https://magiconline.github.io/theme.png><link rel=preload as=image href=https://magiconline.github.io/github.svg><link rel=icon href=https://magiconline.github.io/favicon.ico><link rel=apple-touch-icon href=https://magiconline.github.io/apple-touch-icon.png><meta name=generator content="Hugo 0.100.1"><meta property="og:title" content="分布式定时任务"><meta property="og:description" content="前言 春节集卡瓜分20亿技术 自动化 + 定时执行 + 海量数据 + 高效稳定 = 分布式定时任务
发展历程 单机定时任务 10分钟后Windows电脑自动关机 自动疫情打卡 Linux命令 - CronJob 定时清理机器日志 单机定时任务 Ticker(GO)，定时刷新本地缓存 Quartz 单任务极致控制，没有负载均匀任务 分布式定时任务 平台化管理，分布式部署，支持海量数据
分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。
按触发时机分类：
定时任务：15点触发 延时任务：10s后触发 周期任务：每天15点触发，每10s触发 执行方式：
单级任务：随机触发一台机器执行任务。 广播任务：广播到所有机器上执行同一个任务。 Map任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。 MapReduce任务：在Map任务的基础上，还可以对所有子任务的结果做汇总计算。 定时任务框架 xxl-job
分布式定时任务VS大数据处理引擎：
都可以对海量数据做处理，性能、伸缩性、稳定性都很高。
大数据处理引擎往往致力于将源数据处理成结果数据，分布式定时任务除了能做这个之外，还可以调用HTTP和RPC服务。
以发奖为例：分布式定时任务可以计算哪些用户发奖，然后进行发奖。而大数据处理只能计算哪些用户发奖。
实现原理 核心架构 分布式定时任务核心要解决触发、调度、执行三个关键问题。
触发器：解析任务，生成触发事件。 调度器：分配任务，管理任务生命周期。 执行器：获取执行任务单元，执行任务逻辑。 此外，还需要控制台，提供任务管理和干预的功能。 数据流 控制台 任务：任务元数据 任务实例：任务运行的实例 任务结果：可能任务失败重试产生多个结果 任务历史 任务元数据 包含基础信息、调度时机、执行行为、执行方式。
任务实例 一个确定的Job的一次运行实例。
Job_id 触发时间 状态&结果 过程信息 触发器 核心职责 给定一系列任务，解析他们的触发规则，在规定的时间点触发任务的调度。
设计约束：
需支持大量任务 需支持秒级的任务 周期任务需要多次执行 需保证秒级扫描的高性能，并避免资源浪费 方案1 定时扫描 + 延时消息。"><meta property="og:type" content="article"><meta property="og:url" content="https://magiconline.github.io/post/%E5%88%86%E5%B8%83%E5%BC%8F%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1/"><meta property="article:section" content="post"><meta property="article:published_time" content="2022-06-02T15:43:33+08:00"><meta property="article:modified_time" content="2022-06-02T15:43:33+08:00"><meta itemprop=name content="分布式定时任务"><meta itemprop=description content="前言 春节集卡瓜分20亿技术 自动化 + 定时执行 + 海量数据 + 高效稳定 = 分布式定时任务
发展历程 单机定时任务 10分钟后Windows电脑自动关机 自动疫情打卡 Linux命令 - CronJob 定时清理机器日志 单机定时任务 Ticker(GO)，定时刷新本地缓存 Quartz 单任务极致控制，没有负载均匀任务 分布式定时任务 平台化管理，分布式部署，支持海量数据
分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。
按触发时机分类：
定时任务：15点触发 延时任务：10s后触发 周期任务：每天15点触发，每10s触发 执行方式：
单级任务：随机触发一台机器执行任务。 广播任务：广播到所有机器上执行同一个任务。 Map任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。 MapReduce任务：在Map任务的基础上，还可以对所有子任务的结果做汇总计算。 定时任务框架 xxl-job
分布式定时任务VS大数据处理引擎：
都可以对海量数据做处理，性能、伸缩性、稳定性都很高。
大数据处理引擎往往致力于将源数据处理成结果数据，分布式定时任务除了能做这个之外，还可以调用HTTP和RPC服务。
以发奖为例：分布式定时任务可以计算哪些用户发奖，然后进行发奖。而大数据处理只能计算哪些用户发奖。
实现原理 核心架构 分布式定时任务核心要解决触发、调度、执行三个关键问题。
触发器：解析任务，生成触发事件。 调度器：分配任务，管理任务生命周期。 执行器：获取执行任务单元，执行任务逻辑。 此外，还需要控制台，提供任务管理和干预的功能。 数据流 控制台 任务：任务元数据 任务实例：任务运行的实例 任务结果：可能任务失败重试产生多个结果 任务历史 任务元数据 包含基础信息、调度时机、执行行为、执行方式。
任务实例 一个确定的Job的一次运行实例。
Job_id 触发时间 状态&结果 过程信息 触发器 核心职责 给定一系列任务，解析他们的触发规则，在规定的时间点触发任务的调度。
设计约束：
需支持大量任务 需支持秒级的任务 周期任务需要多次执行 需保证秒级扫描的高性能，并避免资源浪费 方案1 定时扫描 + 延时消息。"><meta itemprop=datePublished content="2022-06-02T15:43:33+08:00"><meta itemprop=dateModified content="2022-06-02T15:43:33+08:00"><meta itemprop=wordCount content="131"><meta itemprop=keywords content><meta name=twitter:card content="summary"><meta name=twitter:title content="分布式定时任务"><meta name=twitter:description content="前言 春节集卡瓜分20亿技术 自动化 + 定时执行 + 海量数据 + 高效稳定 = 分布式定时任务
发展历程 单机定时任务 10分钟后Windows电脑自动关机 自动疫情打卡 Linux命令 - CronJob 定时清理机器日志 单机定时任务 Ticker(GO)，定时刷新本地缓存 Quartz 单任务极致控制，没有负载均匀任务 分布式定时任务 平台化管理，分布式部署，支持海量数据
分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。
按触发时机分类：
定时任务：15点触发 延时任务：10s后触发 周期任务：每天15点触发，每10s触发 执行方式：
单级任务：随机触发一台机器执行任务。 广播任务：广播到所有机器上执行同一个任务。 Map任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。 MapReduce任务：在Map任务的基础上，还可以对所有子任务的结果做汇总计算。 定时任务框架 xxl-job
分布式定时任务VS大数据处理引擎：
都可以对海量数据做处理，性能、伸缩性、稳定性都很高。
大数据处理引擎往往致力于将源数据处理成结果数据，分布式定时任务除了能做这个之外，还可以调用HTTP和RPC服务。
以发奖为例：分布式定时任务可以计算哪些用户发奖，然后进行发奖。而大数据处理只能计算哪些用户发奖。
实现原理 核心架构 分布式定时任务核心要解决触发、调度、执行三个关键问题。
触发器：解析任务，生成触发事件。 调度器：分配任务，管理任务生命周期。 执行器：获取执行任务单元，执行任务逻辑。 此外，还需要控制台，提供任务管理和干预的功能。 数据流 控制台 任务：任务元数据 任务实例：任务运行的实例 任务结果：可能任务失败重试产生多个结果 任务历史 任务元数据 包含基础信息、调度时机、执行行为、执行方式。
任务实例 一个确定的Job的一次运行实例。
Job_id 触发时间 状态&结果 过程信息 触发器 核心职责 给定一系列任务，解析他们的触发规则，在规定的时间点触发任务的调度。
设计约束：
需支持大量任务 需支持秒级的任务 周期任务需要多次执行 需保证秒级扫描的高性能，并避免资源浪费 方案1 定时扫描 + 延时消息。"></head><body class=not-ready data-menu=true><header class=header><p class=logo><a class=site-name href=https://magiconline.github.io/>魔法张的Blog</a><a class=btn-dark></a></p><script>let bodyClx=document.body.classList,btnDark=document.querySelector('.btn-dark'),sysDark=window.matchMedia('(prefers-color-scheme: dark)'),darkVal=localStorage.getItem('dark'),setDark=e=>{bodyClx[e?'add':'remove']('dark'),localStorage.setItem('dark',e?'yes':'no')};setDark(darkVal?darkVal==='yes':sysDark.matches),requestAnimationFrame(()=>bodyClx.remove('not-ready')),btnDark.addEventListener('click',()=>setDark(!bodyClx.contains('dark'))),sysDark.addEventListener('change',e=>setDark(e.matches))</script><nav class=menu><a href=/about/>About</a></nav><nav class=social><a class=github style=--url:url(./github.svg) href=https://github.com/magiconline target=_blank></a></nav></header><main class=main><article class=post-single><header class=post-title><p><time>Jun 2, 2022</time></p><h1>分布式定时任务</h1></header><section class=post-content><h1 id=前言>前言</h1><h2 id=春节集卡瓜分20亿技术>春节集卡瓜分20亿技术</h2><p>自动化 + 定时执行 + 海量数据 + 高效稳定 = 分布式定时任务</p><h1 id=发展历程>发展历程</h1><h2 id=单机定时任务>单机定时任务</h2><ul><li>10分钟后Windows电脑自动关机</li><li>自动疫情打卡</li><li>Linux命令 - CronJob 定时清理机器日志</li><li>单机定时任务 Ticker(GO)，定时刷新本地缓存</li><li>Quartz 单任务极致控制，没有负载均匀任务</li></ul><h2 id=分布式定时任务>分布式定时任务</h2><p>平台化管理，分布式部署，支持海量数据<br>分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。<br>按触发时机分类：</p><ul><li>定时任务：15点触发</li><li>延时任务：10s后触发</li><li>周期任务：每天15点触发，每10s触发</li></ul><p>执行方式：</p><ul><li>单级任务：随机触发一台机器执行任务。</li><li>广播任务：广播到所有机器上执行同一个任务。</li><li>Map任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。</li><li>MapReduce任务：在Map任务的基础上，还可以对所有子任务的结果做汇总计算。</li></ul><h2 id=定时任务框架>定时任务框架</h2><p>xxl-job</p><p>分布式定时任务VS大数据处理引擎：<br>都可以对海量数据做处理，性能、伸缩性、稳定性都很高。<br>大数据处理引擎往往致力于将源数据处理成结果数据，分布式定时任务除了能做这个之外，还可以调用HTTP和RPC服务。<br>以发奖为例：分布式定时任务可以计算哪些用户发奖，然后进行发奖。而大数据处理只能计算哪些用户发奖。</p><h1 id=实现原理>实现原理</h1><h2 id=核心架构>核心架构</h2><p>分布式定时任务核心要解决触发、调度、执行三个关键问题。</p><ul><li>触发器：解析任务，生成触发事件。</li><li>调度器：分配任务，管理任务生命周期。</li><li>执行器：获取执行任务单元，执行任务逻辑。</li><li>此外，还需要控制台，提供任务管理和干预的功能。</li></ul><h3 id=数据流>数据流</h3><p><img src=/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE%2022-06-02%162226.png alt></p><h2 id=控制台>控制台</h2><ul><li>任务：任务元数据</li><li>任务实例：任务运行的实例</li><li>任务结果：可能任务失败重试产生多个结果</li><li>任务历史</li></ul><h3 id=任务元数据>任务元数据</h3><p>包含基础信息、调度时机、执行行为、执行方式。</p><h3 id=任务实例>任务实例</h3><p>一个确定的Job的一次运行实例。</p><ul><li>Job_id</li><li>触发时间</li><li>状态&结果</li><li>过程信息</li></ul><h2 id=触发器>触发器</h2><h3 id=核心职责>核心职责</h3><p>给定一系列任务，解析他们的触发规则，在规定的时间点触发任务的调度。<br>设计约束：</p><ul><li>需支持大量任务</li><li>需支持秒级的任务</li><li>周期任务需要多次执行</li><li>需保证秒级扫描的高性能，并避免资源浪费</li></ul><h3 id=方案1>方案1</h3><p>定时扫描 + 延时消息。<br>提前定时扫描，处理生成任务，放入延时消息队列。</p><h3 id=方案2>方案2</h3><p>时间轮：一种高效利用线程资源进行批量化调度的一种 调度模型。
链表(查询On, 修改O1) -> 最小堆(查询O1, 修改Ologn) -> 时间轮(查询O1, 修改O1) -> 多级时间轮(时->分->秒->任务列表)</p><h3 id=高可用>高可用</h3><p>核心问题</p><ul><li>不同业务之间，任务的调度相互影响怎么办</li><li>负责扫描和触发的机器挂了怎么办</li></ul><p>解决思路</p><ul><li>存储上，不同业务隔离</li><li>运行时，不同业务分开执行</li><li>部署时，多机房集群化部署</li></ul><p>举例：</p><ul><li>单触发器会有单点故障</li><li>多触发器可避免单点故障，需要避免同一任务被多次触发（使用数据库行锁解决，节点越多性能越差。使用分布式锁模式，抢锁成功，触发调度）</li></ul><h2 id=调度器>调度器</h2><h3 id=资源来源>资源来源</h3><ol><li>业务系统提供机器资源</li><li>定时任务平台提供机器资源</li></ol><h3 id=资源调度>资源调度</h3><p>节点选择方式</p><ul><li>随机节点执行：随机选择一个节点执行任务，适用场景：定时对账</li><li>广播执行：所有节点同时执行，适合运维</li><li>分片执行：通过任务分片提高任务执行的效率和资源的利用率</li></ul><h3 id=任务编排>任务编排</h3><p>使用有向无环图DAG进行任务编排。</p><h3 id=故障转移>故障转移</h3><p>保证部分执行单元执行任务失败时，任务最终成功。</p><h3 id=高可用-1>高可用</h3><p>调度器可以集群部署，做到完全的无状态，靠消息队列的重试机制保证任务一定会被调度。</p><h2 id=执行器>执行器</h2><p>基于注册中心，可以做到执行器的弹性扩缩容。<br>注册、调度、回调、心跳检测。</p><h1 id=业务应用>业务应用</h1><p>所有需要定时、延时、周期性执行任务的业务场景，都可以考虑使用分布式定时任务。</p><ul><li>电商：自动关闭订单，自动发消息，自动发优惠券。</li><li>互动：集五福、瓜分红包。</li><li>游戏：发放奖励，更新榜单。</li></ul><h2 id=其它解决方案>其它解决方案</h2><ul><li>发货后10天自动确认收货<ul><li>使用分布式定时任务的延时任务</li><li>使用消息队列的延时消息或定时消息</li></ul></li><li>春节集卡活动统计完成集卡的用户个数和总翻倍数<ul><li>使用分布式定时任务的MapReduce任务</li><li>使用大数据离线处理引擎Hive离线做统计</li><li>使用大数据实时处理引擎Flink实时做统计</li></ul></li></ul><h2 id=其它解决方案对比>其它解决方案对比</h2><p><img src=/img/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE2022-06-02171128.png alt></p></section><nav class=post-nav><a class=next href=https://magiconline.github.io/post/gorm%E5%AE%9E%E8%B7%B5/><span>GORM实践</span><span>→</span></a></nav></article></main><footer class=footer><p>&copy; 2022 <a href=https://magiconline.github.io/>魔法张的Blog</a></p><p>Powered by <a href=https://gohugo.io/ rel=noopener target=_blank>Hugo️️</a>️</p><p><a href=https://github.com/nanxiaobei/hugo-paper rel=noopener target=_blank>Paper 5.1</a></p></footer></body></html>