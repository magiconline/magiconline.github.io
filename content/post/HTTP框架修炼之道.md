---
title: "HTTP框架修炼之道"
date: 2022-06-15T19:04:23+08:00
draft: false
---

# 1. 再谈HTTP协议
## 1.1 HTTP协议是什么
HTTP：超文本传输协议  

### 为什么需要协议？
需要明确的边界
- 开始
- 结束

能够携带信息
- 什么消息
- 消息类型


## 1.2 协议里有什么
- 请求行、状态行
  - 方法名、URL、协议版本
  - 协议版本、状态码、状态码描述
- 请求头、响应头
  - 
- 请求体、响应体

## 1.3 请求流程
- 业务层
- 服务治理层
- 中间件层
- 路由层
- 协议编码层
- 传输层


## 1.4 不足与展望
- HTTP1
  - 队头阻塞
  - 传输效率低
  - 明文传输不安全
- HTTP2
  - 多路复用
  - 头部压缩
  - 二进制协议
- QUIC
  - 基于UDP实现
  - 解决队头阻塞
  - 加密减少握手次数
  - 支持快速启动



# 2 HTTP框架的设计与实现
## 2.1 分层设计
- 高内聚、低耦合
- 易复用
- 高扩展性

## 2.2 应用层设计
提供合理的 API
- 可理解性
- 简单性
- 冗余性
- 兼容性
- 可测性
- 可见性

## 2.3 中间件设计
中间件需求：
- 配合 Handler实现一个完整的请求处理生命周期
- 拥有预处理逻辑与后处理逻辑
- 可以注册多中间件
- 对上层模块、用户逻辑模块易用

洋葱模型，适用场景：
- 日志记录
- 性能统计
- 安全控制
- 事务处理
- 异常处理

## 2.4 路由设计
框架路由实际上就是为URL匹配对应的处理函数
- 静态路由
- 参数路由
- 路由修复
- 冲突路由以及优先级
- 匹配HTTP方法
- 多处理函数，方便添加中间件
  
实现思路
- map[string]handlers
  - 只能处理静态路由
- 前缀匹配树，在每个节点存储handler
  - 可以处理参数路由

匹配HTTP方法：
在前缀树外部设置路由映射表 HTTP/METHOD -> tree

## 2.5 协议层设计
抽象出合适的接口

## 2.6 网络层设计
阻塞IO、非阻塞IO

网络库：net(BIO)，netpoll(NIO)

# 3 性能修炼之道
## 3.1 针对网络库的优化
- 存下全部的Header
- 减少系统调用次数
- 能够复用内存
- 能够多次读


## 3.2 针对协议的优化
- Headers 解析
  - 找到 Header Line 边界：\r\n
  - SIMD

## 3.3 Header key 规范化

## 3.4 热点资源池化
- 取
  - 减少了内存分配
  - 提高了内存复用
  - 降低了GC压力
  - 性能提升
- 舍
  - 额外的Reset逻辑
  - 请求内有效
  - 问题定位难度增加

# 企业实践

