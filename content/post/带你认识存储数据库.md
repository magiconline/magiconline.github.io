---
title: "带你认识存储数据库"
date: 2022-06-03T14:13:26+08:00
draft: false
---

# 经典案例
## 数据的持久化
1. 校验数据的合法性
2. 修改内存（用高效的数据结构组织数据）
3. 写入存储介质（以寿命&性能友好的方式写入硬件）

## 潜在问题
- 数据库怎么保证数据不丢
- 数据库怎么处理多人同时修改的问题
- 为什么用数据库，除了数据库还能存到别的存储系统吗
- 数据库只能处理结构化数据吗
- 有哪些操作数据库的方式，要用什么编程语言


# 存储 & 数据库简介
## 存储系统
一个提供了读写、控制类接口，能够安全有效地把数据持久化的软件，就可以称为存储系统。  
特点：性能敏感、代码简单又复杂、容易受硬件影响。  

## 数据库
关系：任意元素组成的若干有序偶对  
SQL：一种DSL，方便人类阅读的关系代数的表达形式  
### 关系型数据库
数据化结构友好、支持事务、支持复杂查询语言SQL。  

### 非关系型数据库
一般不要求严格的结构化。
半结构化数据友好、可能支持事务、可能支持复杂查询语言。

## 数据库 VS 经典存储
### 结构化数据关系
关系型数据库以表形式管理。  
写入文件，自定义行，管理结构。  

### 事务能力
数据库支持事务：
- Atomicity：事务内的操作要么全做，要么不做。
- Consistency，事务执行前后，数据状态是一致的。
- Isolation，可以隔离多个并发事务，避免影响。
- Durability，事务一旦提交成功，数据保证持久性。

### 复杂查询能力
SQL VS 编程语言


# 主流产品剖析
## 单机存储
单机存储：单个计算机节点上的存储软件系统，一般不涉及网络交互。  
### 本地文件系统
文件系统接口：Ext2/3/4，sysfs，rootfs等，都遵循VFS的统一抽象接口。  
Index Node: 记录文件元数据，如ID，大小、权限、位置等。inode是一个文件的唯一标识，会被存储到磁盘上，inode的总数在格式化文件系统时就固定了。
Directory Entry: 记录文件名、inode指针、层级关系等。dentry是内存结构，与inode的关系是N:1。  

### key-value存储
使用方式: put(k, v) & get(k)
常见的数据结构：LSM-Tree
产品：rocksdb


## 分布式存储
分布式存储：在单机存储基础上实现了分布式协议，涉及大量网络交互。  
### 分布式文件系统
HDFS，Ceph

## 单机关系型数据库
Oracle、MySQL、PostgreSQL。  
通用组件：
- Query Engine：解析query，生成查询计划
- Txn Manager：负责事务并发管理
- Lock Manager：负责锁相关的策略
- Storage Engine：负责组织内存、磁盘数据结构
- Replication：负责主备同步

关键内存数据结构：B-Tree、B+-Tree、LRU List  
关键磁盘数据结构：WriteAheadLog(Redo Log)、page

## 单机非关系型数据库
MongoDB、Redis、Elasticsearch  
关系型数据库一般直接使用SQL交互，而非关系型数据库交互方式各不相同。  

- ElasticSearch
  - 面向文档存储
  - 文档可序列化成JSON
  - 存在index（文档的集合）
  - 存储和构建索引能力以来搜索引擎
  - 实现了大量搜索数据结构&算法
  - 支持RESTFUL API，支持弱SQL交互
- MongoDB
  - 面向文档存储
  - 文档可序列化成JSON/BSON
  - 存在collection
  - 依赖wiredTiger引擎
  - 4.0后开始支持事务
  - 常用client/SDK交互，可以支持弱SQL
- Redis
  - 数据结构丰富(hash表、set、zset、list)
  - C实现，炒高性能
  - 基于内存，支持AOF、RDB持久化
  - 常用redis-cli、多语言交互

跟关系型数据库相比，ES天然支持模糊搜索，还能自动算出关联程度。


## 分布式数据库
单机数据库遇到的问题：容量、弹性、性价比

### 解决容量问题
单点容量有限，受硬件限制。
分布式存储节点池化，动态扩缩容。

### 解决弹性问题
可以扩缩容

### 解决性价比问题
按需扩容（CPU、内存、存储）

### More
单写VS多写，从磁盘弹性到内存弹性，分布式事务优化


# 新技术演进
## Bypass OS kernel
- 避免系统调用带来的性能损耗，直接从用户态访问磁盘。
- 磁盘性能提高后，中断次数随之上升，不利于IO性能。
- SPDK 绑定特定CPU核用轮询代替中断
- 使用无锁队列，降低并发开销

## AI 
AI决策，行列混存

## 高性能硬件
### RDMA网络
不经过传统的网络协议栈，把用户态虚拟内存映射给网卡，减少拷贝、CPU开销。
### Persistent Memory
IO时延介于SSD与内存之间，可以用作内存或持久化介质。
### 可编程交换机
在交换机层对网络包做计算逻辑，在数据库场景下实现缓存一致性协议等。
### CPU/GPU/DPU
众核、显存、异构计算