---
title: "分布式定时任务"
date: 2022-06-02T15:43:33+08:00
draft: false
---

# 前言
## 春节集卡瓜分20亿技术
自动化 + 定时执行 + 海量数据 + 高效稳定 = 分布式定时任务

# 发展历程
## 单机定时任务
- 10分钟后Windows电脑自动关机
- 自动疫情打卡
- Linux命令 - CronJob 定时清理机器日志
- 单机定时任务 Ticker(GO)，定时刷新本地缓存
- Quartz 单任务极致控制，没有负载均匀任务

## 分布式定时任务
平台化管理，分布式部署，支持海量数据  
分布式定时任务是把分散的、可靠性差的定时任务纳入统一的平台，并实现集群管理调度和分布式部署的一种定时任务的管理方式。  
按触发时机分类：
- 定时任务：15点触发
- 延时任务：10s后触发
- 周期任务：每天15点触发，每10s触发

执行方式：
- 单级任务：随机触发一台机器执行任务。
- 广播任务：广播到所有机器上执行同一个任务。
- Map任务：一个任务可以分出多个子任务，每个子任务负责一部分的计算。
- MapReduce任务：在Map任务的基础上，还可以对所有子任务的结果做汇总计算。
  
## 定时任务框架
xxl-job

分布式定时任务VS大数据处理引擎：  
都可以对海量数据做处理，性能、伸缩性、稳定性都很高。  
大数据处理引擎往往致力于将源数据处理成结果数据，分布式定时任务除了能做这个之外，还可以调用HTTP和RPC服务。  
以发奖为例：分布式定时任务可以计算哪些用户发奖，然后进行发奖。而大数据处理只能计算哪些用户发奖。

# 实现原理
## 核心架构
分布式定时任务核心要解决触发、调度、执行三个关键问题。  
- 触发器：解析任务，生成触发事件。
- 调度器：分配任务，管理任务生命周期。
- 执行器：获取执行任务单元，执行任务逻辑。
- 此外，还需要控制台，提供任务管理和干预的功能。

### 数据流
![](/img/屏幕截图2022-06-02162226.png)

## 控制台
- 任务：任务元数据
- 任务实例：任务运行的实例
- 任务结果：可能任务失败重试产生多个结果
- 任务历史

### 任务元数据
包含基础信息、调度时机、执行行为、执行方式。

### 任务实例
一个确定的Job的一次运行实例。
- Job_id
- 触发时间
- 状态&结果
- 过程信息

## 触发器
### 核心职责
给定一系列任务，解析他们的触发规则，在规定的时间点触发任务的调度。  
设计约束：
- 需支持大量任务
- 需支持秒级的任务
- 周期任务需要多次执行
- 需保证秒级扫描的高性能，并避免资源浪费

### 方案1
定时扫描 + 延时消息。  
提前定时扫描，处理生成任务，放入延时消息队列。  

### 方案2
时间轮：一种高效利用线程资源进行批量化调度的一种 调度模型。 
链表(查询On, 修改O1) -> 最小堆(查询O1, 修改Ologn) -> 时间轮(查询O1, 修改O1) -> 多级时间轮(时->分->秒->任务列表)

### 高可用
核心问题
- 不同业务之间，任务的调度相互影响怎么办
- 负责扫描和触发的机器挂了怎么办

解决思路
- 存储上，不同业务隔离
- 运行时，不同业务分开执行
- 部署时，多机房集群化部署

举例：
- 单触发器会有单点故障
- 多触发器可避免单点故障，需要避免同一任务被多次触发（使用数据库行锁解决，节点越多性能越差。使用分布式锁模式，抢锁成功，触发调度）

## 调度器
### 资源来源
1. 业务系统提供机器资源
2. 定时任务平台提供机器资源

### 资源调度
节点选择方式
- 随机节点执行：随机选择一个节点执行任务，适用场景：定时对账
- 广播执行：所有节点同时执行，适合运维
- 分片执行：通过任务分片提高任务执行的效率和资源的利用率

### 任务编排
使用有向无环图DAG进行任务编排。

### 故障转移
保证部分执行单元执行任务失败时，任务最终成功。

### 高可用
调度器可以集群部署，做到完全的无状态，靠消息队列的重试机制保证任务一定会被调度。

## 执行器
基于注册中心，可以做到执行器的弹性扩缩容。  
注册、调度、回调、心跳检测。

# 业务应用
所有需要定时、延时、周期性执行任务的业务场景，都可以考虑使用分布式定时任务。  

- 电商：自动关闭订单，自动发消息，自动发优惠券。
- 互动：集五福、瓜分红包。
- 游戏：发放奖励，更新榜单。

## 其它解决方案
- 发货后10天自动确认收货
  - 使用分布式定时任务的延时任务
  - 使用消息队列的延时消息或定时消息
- 春节集卡活动统计完成集卡的用户个数和总翻倍数
  - 使用分布式定时任务的MapReduce任务
  - 使用大数据离线处理引擎Hive离线做统计
  - 使用大数据实时处理引擎Flink实时做统计


## 其它解决方案对比
![](/img/屏幕截图2022-06-02171128.png)