---
title: "RPC框架"
date: 2022-06-10T22:35:06+08:00
draft: false
---

# 基本概念
## 本地函数调用
1. 将参数压栈
2. 通过函数指针找到函数
3. 进入函数取出参数
4. 执行
5. 将返回值压栈
6. 返回，取出返回值


## 远程函数调用
RPC需要解决的问题
1. 函数映射
2. 数据转换成字节流
3. 网络传输

## RPC概念模型
本地user调用函数，user-stub把函数调用打包，RPCRuntime通过网络传输，远端RPCRuntime通过网络接收，Server-stub解包参数，server调用函数。

## 一次RPC的完整过程
- IDL(Interface description language)文件
  - IDL通过中立的方式描述接口，是的在不同平台上运行的对象和用不同语言编写的程序可以相互通信。
- 生成代码
  - 通过编译器工具把IDL文件转换成对应语言的静态库
- 编解码
  - 从内存中表示到字节序列的转换，也叫作序列化
- 通信协议
  - 规范了数据在网络中的传输内容和格式。除必须的请求/相应数据外，通常还会包含额外的元数据。
- 网络传输
  - 通常基于成熟的网络库走TCP/UDP传输

## RPC的好处
1. 单一职责，有利于分工协作和运维开发
2. 可扩展性强，资源使用率更优
3. 故障隔离，服务的整体可靠性更高
   
## RPC带来的问题
1. 服务宕机，对方应该如何处理？
2. 在调用过程中发生网络异常，如何保证消息的可达性？
3. 请求量突增导致服务无法及时处理，有哪些应对措施？


# 分层设计
## 以Apache Thrift为例
业务code，生成代码，编解码，通信协议，网络传输

## 编解码层
数据格式分类：
- 语言特定的格式
- 文本格式：JSON，CSV
- 二进制编码：Protobuf

选型：
- 兼容性：支持自动增加新的字段，而不影响老的服务
- 通用性：跨平台、跨语言
- 性能：编码后数据大小和编码耗费时长

## 协议层
概念：
- 特殊结束符：一个特殊字符作为每个写一单元结束的标示
- 变长协议：定长 + 不定长的部分组成，其中定长的部分需要描述不定长内容的长度

协议构造：
- LENGTH：数据包大小
- HEADER MAGIC：标示版本信息
- SEQUENCE NUMBER：标示数据包的seqID，用于多路复用
- HEADERSIZE：头部长度
- 变长头部
- PROTOCOL ID：编解码方式
- TRANSFORM ID：压缩方式
- INFO ID：定制的meta信息
- PAYLOAD：消息体

协议解析
- 读取MAGIC NUMBER
- 读取头部
- 读取PAYLOAD

## 网络通信层 
网络库选择：
- 提供易用API
  - 封装Socket API
  - 连接管理和事件分发
- 功能
  - 协议支持：tcp、udp和uds等
  - 优雅退出、异常处理等
- 性能
  - 应用层buffer减少copy
  - 高性能定时器、对象池等



# 关键指标
## 稳定性
- 保障策略
  - 熔断：保护调用方，防止被调用的服务出现问题而影响到整个链路
  - 限流：保护被调用方，防止大流量把服务压垮
  - 超时控制：避免浪费资源在不可用节点上

- 请求成功率
- 长尾请求
- 注册中间件

## 易用性
- 开箱即用：提供合理的默认参数和丰富的文档
- 周边工具：生成代码工具、脚手架工具

## 扩展性
- 中间件
- 参数
- 编解码层
- 协议层
- 网络传输层
- 插件扩展

## 观测性
- log、Metric、Tracing
- 内置观测性服务

## 高性能
- 场景
  - 单机、多级
  - 单链接、多连接
  - 多client、多server
  - 不同大小的请求包
  - 不同请求类型：pingpong、streaming等
- 目标
  - 高吞吐
  - 低延迟
- 手段
  - 连接池
  - 多路复用
  - 高性能编解码协议 
  - 高性能网络库

# 企业实践

